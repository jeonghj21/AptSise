<!-- Sidebar -->
<script>
var gRegionsMap = {}; //
var gRegionsArr = [];
var gDrawOptions = {};
let gChartParams = null;

function constructSel(sel, arr, sortKey = null, filterFunc = null, removeAllFlag = false) {
	if (removeAllFlag)
		sel.empty();
	else
		sel.children().not(':first').remove();

	if (filterFunc) {
		arr = arr.slice();
		$.each(arr, function(index, item) {
			if (!filterFunc(index, item))
				delete arr[index];
		});
	}

	if (sortKey)
		arr.sort(function(a, b) { return (a[sortKey] < b[sortKey]) ? -1 : ((a[sortKey] == b[sortKey]) ? 0 : 1); });

	$.each(arr, function(idx, r) {
		if (r) { // not filtered out element
			option = document.createElement("option");
			option.value = r['key'];
			option.innerText = r['name'];
			sel.append(option);
		}
	});
}

function initRegions() {
	sel = $("#region_key1");
	constructSel(sel, gRegionsArr);
}

function clearChildSelect(sel) {
	
	constructSel(sel, {});
	if (sel.attr('id') == 'apt') {
		$('#apt').val('').change();
		$('#danji').attr('disabled', true);
	}

	let child = sel.attr("child");
	if (!child)
		return;


	child = $('#' + child);
	clearChildSelect(child);

}

function refreshRegion(sel) {

	let child = sel.attr("child");
	child = $('#' + child);
	clearChildSelect(child);

	params = getChartParams();
	let value = sel.val();
	if (value == '') { // just clear only
		return;
	}

	let level = gRegionsMap[value]['level'];
	if (level == 3) {
		refreshApt(child);
		return;
	}
	
	let arr = gRegionsMap[value]['subregions'];

	constructSel(child, arr, 'name' /* sort by name */, function(index, item) { return item['level'] == level+1; });

}

function refreshApt(apt) {

	clearChildSelect(apt);

	var region_key2 = $("#region_key2").val();
	var region_key3 = $("#region_key3").val();
	if (region_key2 == "" || region_key3 == "")
		return;

	var aptArr = gRegionsMap[region_key3]['subregions'];

	$('#danji').attr('disabled', false);
	var func = ($("#danji").is(":checked") 
		? function(index, data) { 
			return data['danji'] == 'Y'; // data is array of id, array of name, danji_flag
		  } 
		: null); 
	if (aptArr && aptArr.length > 0) { // already cached
		constructSel($('#apt'), aptArr, -1 /* no sort */, func);
		return;
	}

	url = "{{ config['BASE_URL'] }}getApt?region_key="+region_key3;
	$.getJSON(url, function(data){
		aptArr = JSON.parse(data);
		gRegionsMap[region_key3]['subregions'] = aptArr;
		constructSel($('#apt'), aptArr, -1 /* no sort */, func);
	});
}

function getValueOfParam(params, key) {
	var input = params[key];
	if (Array.isArray(input)) {
		if (input.length == $('#chart_conditions #'+key).length)
			return '';
		else { 
			var value = '';
			input.forEach(function(item) {
				value += item.val();
			});
			return value;
		}
	} else if (typeof input == "string" || typeof input == "number") {
		if (key == "region_key") {
			if ($('#region_key3').val() != '') {
				params[key] = $('#region_key3').val();
				input = params[key];
			} else if ($('#region_key2').val() != '') {
			    params[key] = $('#region_key2').val();
				input = params[key];
			} else if ($('#region_key1').val() != '') {
			    params[key] = $('#region_key1').val();
				input = params[key];
			}
		}
		return input;
	} else {
		// skip if no input, not checked
		if (input.val() == null || (input.attr('type') == 'checkbox' && !input.is(':checked')))
			return '';
		return input.val();
	}
}

function setValueOfParam(params, key, newValue) {
	var input = params[key];
	if (Array.isArray(input)) {
		var pos = 0;
		input.forEach(function(item) {
			if(item.val() == newValue.substring(pos, pos+input.value_len)) {
				item.prop("checked", true);
			}
			pos += input.value_len;
		});
	} else if (typeof input == "string" || typeof input == "number") {
		if (params[key] != newValue && key == "region_key") {
			let region = gRegionsMap[newValue];
			if (region) {
				let level = region['level'];
				let region_sel = $('#region_key'+level);
				region_sel.val(newValue).change();
			}
		}
		params[key] = newValue;
	} else {
		input.val(newValue).change();
	}
}

function initChartParams() {
	let params = {};

	$('#chart_conditions input, #chart_conditions select').each(function(index, item) {
		input = $(item);
		key = input.attr('id');
		if (params[key]) {
			tmp = params[key];
			if (!Array.isArray(tmp)) {
				params[key] = [ tmp ];
				params[key].value_len = input.val().length;
			}
			params[key].push(input);
		} else
			params[key] = input;
	});

	params['orderby'] = '';
	params['page'] = '';
	params['ym'] = '';
	params['region_key'] = '0000000000';

	var map = { params: params };

	Object.keys(params).forEach(function(key) {

		var item = params[key];
		var input = item;
		if (Array.isArray(item))
			input = item[0];

		Object.defineProperty(map, key,
		{ get: function () { 
			return getValueOfParam(this.params, key);
		}, set: function(newValue) {
			setValueOfParam(this.params, key, newValue);
		}});
	});

	return map;

}

function getChartParams() {

	if (gChartParams == null) {

		gChartParams = initChartParams();
	}

	return gChartParams;
}

function requestSaleStat() {

	var params = getChartParams();

	var title = getRegionTitle(params);

	drawSaleStat(params, title);

}

function requestSaleLine() {

	var title = $('select#apt option:selected').text();
	var params = getChartParams();

	drawSaleLineChart(params, title);

}

function requestRankChart(gubun) {

	var params = getChartParams();

	// Region Rank chart's minimum level = 2
	if (gubun == 'Region' && gRegionsMap[params['region_key']]['level'] == 3)
		params['region_key'] = gRegionsMap[params['region_key']]['upper'];

	drawRankChart(gubun, params);
}

function toggleTerms() {
	if($('#toggle_term').is(':visible')) {
		$('#toggle_term').hide();
		$('#toggle_btn').text('▼ 보이기');
	} else {
		$('#toggle_term').show();
		$('#toggle_btn').text('▲ 숨기기');
	}
}

function toggleYMTable(btn, target, desc) {
	var div;
	if (desc)
		div = $("#ym_table_desc_div");
	else
		div = $("#ym_table_asc_div");
	if (div.is(':visible')) {
		$('.popup').hide();
		$('#toggle_btn').text('▼ 보이기');
	} else {
		$('.popup').hide();
		var pos = btn.position();
		div.attr("target", target);
		div.css({top: (pos.top+btn.outerHeight())+'px', left: pos.left+'px', display: 'block'});
	}
}

function wrapWindowByMask() { 
	//화면의 높이와 너비를 구한다. 
	var maskHeight = $(document).height(); 
	var maskWidth = $(window).width(); 
	
	//마스크의 높이와 너비를 화면 것으로 만들어 전체 화면을 채운다. 
	$('#fade').css({ 'width': maskWidth, 'height': maskHeight }); 
} 
	
/// 화면의 중앙에 레이어띄움 
function showMessage(label = '조회') { 
	wrapWindowByMask(); 
	$("#light").css("position", "absolute"); 
	$("#light").css("top", Math.max(0, (($(window).height() - $("#light").outerHeight()) / 2) + $(window).scrollTop() - 100) + "px"); 
	$("#light").css("left", Math.max(0, (($(window).width() - $("#light").outerWidth()) / 2) + $(window).scrollLeft()) + "px"); 
	$("#task").text(label);
	$('#fade').show(); 
	$('#light').show(); 
} 

function closeMessage() { 
	$('#fade').hide(); 
	$('#light').hide(); 
}

</script>
<div class="sidebar" style="width:200px; margin-left:5px;">
	<div class="my-box" id="chart_conditions">
	<label><strong>조회기간</strong></label><br>
		<input id=from_ym readOnly style="width:60px;"><a onclick="event.stopPropagation(); toggleYMTable($(this), 'from_ym', false);">▼</a> ~ 
		<input id=to_ym readOnly style="width:60px;"><a onclick="event.stopPropagation(); toggleYMTable($(this), 'to_ym', true); return false;">▼</a><br>
		<table>
			<tr>
				<td>시도</td>
				<td>
					<select child=region_key2 onchange="refreshRegion($(this));" id="region_key1" style="width:100%;">
						<option value=''>전체</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>시군구</td>
				<td>
					<select child=region_key3 onchange="refreshRegion($(this));" id="region_key2" style="width:100%;">
						<option value=''>전체</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>읍면동</td>
				<td>
					<select child=apt onchange="refreshRegion($(this));" id="region_key3" style="width:100%;">
						<option value=''>전체</option>
					</select>
				</td>
			</tr>
			<tr>
				<td><input type=checkbox id=danji value=N disabled onchange="if (this.checked) this.value = 'Y'; else this.value = 'N'; refreshApt($('#apt'));" />단지만
				</td>
				<td>
					<select name="apt" id="apt" style="width:100%;" onchange="$('#apt_btn').attr('disabled', $('select#apt option:selected').val() == '');">
						<option value=''>전체</option>
					</select>
				</td>
			</tr>
		</table>
		<span class="bar-item"><strong>추가 조건</strong></span>&nbsp;&nbsp;<a id=toggle_btn onclick="toggleTerms();" >▼ 보이기</a><br>
		<div id=toggle_term style="display:none;">
			<label>연식:</label>
				<select id=ages>
					<option value="">ALL</option>
					{%for i in range(1, 20)%} 
					<option value={{i}}>{{i}}</option>
					{%endfor%} 
				</select> 년
				<select id=age_sign>
					<option value="<">이내</option>
					<option value="=>">이상</option>
				</select><br>
			<label>전용면적</label><br>
				<input type=checkbox id=area_type value=01 checked>60m<sup>2</sup> 이하<br>
				<input type=checkbox id=area_type value=02 checked>60~85m<sup>2</sup> 이하<br>
				<input type=checkbox id=area_type value=03 checked>85~135m<sup>2</sup> 이하<br>
				<input type=checkbox id=area_type value=04 checked>135m<sup>2</sup> 초과
		</div>
	</div>
	<div class="my-box">
		<label><strong>평균평단가 추이</strong></label><br>
		<button id='region_btn' onclick="requestSaleStat();">지역별 평균평단가 추이</button>
		<button id='apt_btn' onclick="requestSaleLine();" disabled>아파트별 평균평단가 추이</button>
		<div id="draw_options">
			<label><strong>차트 옵션</strong></label><br>
			<input id=draw_overlap type=checkbox>겹쳐 그리기</input><br>
			<input id=draw_relative type=checkbox onchange="updateChart();">상대수치로 보기</input><br>
			<input id=draw_ma type=checkbox onchange="updateChart();">연간 이동평균 같이 보기</input><br>
			<input id=draw_volume type=checkbox onchange="updateChart();">거래량 같이 보기<br></input>
		</div>
	</div>
	<div class="my-box" id="chart_conditions">
		<label><strong>연간 평균평단가 비교</strong>(위에서 지역 선택)</label><br>
			<input id=base_ym readOnly style="width:60px;"><a onclick="event.stopPropagation(); toggleYMTable($(this), 'base_ym', true);">▼</a> VS 
				<select id=years>
					{%for i in range(1, 20)%} 
					<option value={{i}}>{{i}}</option>
					{%endfor%} 
				</select>년전<br>
			<button onclick="requestRankChart('Region');">지역별 순위</button><br>
<!--			<button onclick="drawBoxPlotChart(getChartParams());">지역별 Box Plot</button><br> -->
			<button onclick="requestRankChart('Apt');">아파트별 순위</button>

	</div>
	<div class="my-box">
		<label>최근 작업 상황</label><br>
		<span>{{result['ym']}} : {{result['start_dt']}} ~ {{result['end_dt']}} : {{result['status']}}</span>
	</div>
</div>
<div id="ym_table_asc_div" class=popup style="display: none; position:absolute; z-index:999;">
<table id="ym_table_asc">
	<tbody>
	</tbody>
</table>
</div>
<div id="ym_table_asc_div" class=popup style="display: none; position:absolute; z-index:999;">
<table id="ym_table_asc">
	<tbody>
	</tbody>
</table>
</div>
<div id="ym_table_desc_div" class=popup style="display: none; position:absolute; z-index:999;">
<table id="ym_table_desc">
	<tbody>
	</tbody>
</table>
</div>
<script>
function setErrorHandler() {
	window.onerror = function (msg, url, lineNo, columnNo, error) {
		var string = msg.toLowerCase();
	    var message = [
			'Message: ' + msg,
			'Line: ' + lineNo,
			'Column: ' + columnNo,
			'Error object: ' + JSON.stringify(error)
		].join(' - ');
	
		alert(message);

		return false;
	};

	$.ajaxSetup({
		"error":function() { 
			alert("서버에서 오류가 발생했습니다.");
			$('.popup').hide();
			closeMessage();
		}
	});
}

function initDrawOptionsMap() {

	var params = {};

	$('#draw_options input').each(function(index, item) {
		input = $(item);
		var key = input.attr('id');
		params[key] = input;
	});

	gDrawOptions = { params: params };

	Object.keys(params).forEach(function(key) {

		var item = params[key];
		var input = item;

		Object.defineProperty(gDrawOptions, key, {
			get: function () { 
				var input = this.params[key];
				return input.is(':checked');
			},
			set: function(bool) {
				var item = this.params[key];
				item.attr('checked', bool == true);
			}
		});
	});
	Object.defineProperty(gDrawOptions, "checked", {
		set: function(bool) {
			Object.values(this.params).forEach(function(item) {
				item.prop('checked', bool);
			});
		}
	});
	Object.defineProperty(gDrawOptions, "disabled", {
		set: function(bool) {
			Object.values(this.params).forEach(function(item) {
				item.prop('disabled', bool);
			});
		}
	});

}

function makeHtml4MonthsTR(y, to_ym) {

	var html = "<tr>";
	html += "<td>" + y + "년</td>";
	for(var m = 1; m <= 12; m++) {
		var ym = (y*100 + m <= to_ym ? (y + "" + (m < 10 ? "0"+m : m)) : "");
		html += "<td class=one_ym value='" + ym + "'>" + (ym.length > 0 ? m+"월" : "") + "</td>";
	}
	html += "</tr>:"

	return html;
}

function initSelectYMTable() {

	const MIN_YY = 2006;
	const DEFAULT_PERIOD = 3;

	var today = new Date();
	var yy = today.getFullYear();
	var mm = today.getMonth()+1;
	var to_ym = yy * 100 + mm;
	// from_ym set to 3 years minus one month ago
	var from_ym = (mm == 12 ? (yy - (DEFAULT_PERIOD - 1)) * 100 + 1 : (yy - DEFAULT_PERIOD) * 100 + mm + 1);

	for(var y = MIN_YY; y < to_ym / 100; y++) {
		var html = makeHtml4MonthsTR(y, to_ym);
		$('#ym_table_asc > tbody:last').append(html);
	};
	$('input#from_ym').val(from_ym);
	$('input#to_ym').val(to_ym);
	$('input#base_ym').val(to_ym);
	for(var y = Number.parseInt(to_ym / 100); y >= MIN_YY; y--) {
		var html = makeHtml4MonthsTR(y, to_ym);
		$('#ym_table_desc > tbody:last').append(html);
	};

	$('.one_ym').click( function() {
		var div = $($(this).parents('div')[0]);
		var target = div.attr("target");
		if ($(this).attr('value') != '') {
			$('#'+target).val($(this).attr('value'));
			div.hide();
		}
	});

	$(".one_ym").hover(function(){
		if ($(this).attr('value') != '')
			$(this).css("background-color", "yellow");
    }, function(){
		$(this).css("background-color", $(this).parent().css("background-color"));
	});

}

$(document).ready(function(){ 

	initSelectYMTable();

	initDrawOptionsMap();

	setErrorHandler();

	// hide any popup div at uncaptured click event
	$(window).click(function(e) {
		$('.popup').hide();
	});

	showMessage('초기화');
	$.getJSON("{{ config['BASE_URL'] }}getRegions", function(data){
		let regions = JSON.parse(data);
		for (var i = 0; i < regions.length; i++) {
			const region = regions[i];
			gRegionsMap[region['key']] = region;
			let level = region['level'];
			if (level == 0)
				continue;
			if (level == 1)
				gRegionsArr.push(region);
			let upper = gRegionsMap[region['upper']];
			if (!upper['subregions'])
				upper['subregions'] = [];
			upper['subregions'].push(region);
		}
		initRegions();
		closeMessage();
	});
});

</script>

