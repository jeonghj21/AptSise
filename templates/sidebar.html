<!-- Sidebar -->
<script>
var gRegionsMap = {};
var gDongsMap = {};
var gAptMap = {};
var gDrawOptions = {};

function setDrawOption(checkbox) {
	gDrawOptions[checkbox.id] = checkbox.checked;
}

function constructSel(sel, data, allTitle, allValue) {
	sel.empty();
	var option = document.createElement("option");
	option.value = allValue;
	option.innerText = allTitle;
	sel.append(option);
	var temp = [];
	if (!Array.isArray(data) && typeof data == "object") {
		for(const key in data) {
			temp.push([key, data[key]]);
		}
		data = temp;
	}
	data.sort(function(a, b) { return (a[1] < b[1]) ? -1 : ((a[1] == b[1]) ? 0 : 1); });
	$.each(data, function(idx, r) {
		option = document.createElement("option");
		option.value = r[0];
		option.innerText = r[1];
		sel.append(option);
	});
}

function initRegions() {
	sel = $("#region");
	constructSel(sel, gRegionsMap, "서울 전체", "11000");
}

function refreshDong(val) {
	var sel = $("#dong");
	var dongs = [];
	if (val != '11000')
		dongs = gDongsMap[val];
	constructSel(sel, dongs, "구 전체", "00000");
}

function constructAptSel(region, dong) {

	var data = [];
	if ($("#danji").is(":checked")) {
		$.each(gAptMap[region+dong], function(idx, r) {
			if (r[2] != null)
				data.push(r);
		});
		list = data;
	} else {
		data = gAptMap[region+dong];
	}

	constructSel($("#apt"), data, "아파트를 선택하세요", "");
}

function refreshApt() {

	region = $("#region").val();
	dong = $("#dong").val();
	if (gAptMap[region+dong] != null) {
		constructAptSel(region, dong);
		return;
	}

	url = "{{ config['BASE_URL'] }}getApt?region="+region+"&dong="+dong;
	$.getJSON(url, function(data){
		gAptMap[region+dong] = JSON.parse(data);
		constructAptSel(region, dong);
	});
}

function getChartConditions() {

	var params = {};

	$('#chart_conditions input, #chart_conditions select').each(function(index, item) {
		input = $(item);
		key = input.attr('id');
		if (params[key]) {
			tmp = params[key];
			if (!Array.isArray(tmp)) {
				params[key] = [ tmp ];
				params[key].value_len = input.val().length;
			}
			params[key].push(input);
		} else
			params[key] = input;
	});

	params['orderby'] = '';
	params['page'] = '';
	params['ym'] = '';

	var map = { params: params };

	Object.keys(params).forEach(function(key) {

		var item = params[key];
		var input = item;
		if (Array.isArray(item))
			input = item[0];

		Object.defineProperty(map, key,
		{ get: function () { 
			var input = this.params[key];
			if (Array.isArray(input)) {
				if (input.length == $('#chart_conditions #'+key).length)
					return '';
				else { 
					var value = '';
					input.forEach(function(item) {
						value += item.val();
					});
					return value;
				}
			} else if (typeof input == "string" || typeof input == "number") {
				return input;
			} else {
				// skip if no input, not checked
				if (input.val() == null || (input.attr('type') == 'checkbox' && !input.is(':checked')))
					return '';
				return input.val();
			}
		}, set: function(newValue) {
			var input = this.params[key];
			if (Array.isArray(input)) {
				var pos = 0;
				input.forEach(function(item) {
					if(item.val() == newValue.substring(pos, pos+input.value_len)) {
						item.prop("checked", true);
					}
					pos += input.value_len;
				});
			} else if (typeof input == "string" || typeof input == "number") {
				this.params[key] = newValue;
			} else {
				input.val(newValue).change();
			}
		}});
	});

	return map;

}
/*
function getChartConditions() {

	params = {};
	dup_params = {};

	$('#chart_conditions input, #chart_conditions select').each(function(index, item) {
		input = $(item);

		// skip if no input, not checked
		if (input.val() == null || (input.attr('type') == 'checkbox' && !input.is(':checked')))
			return;
		key = input.attr('id');
		value = params[key];
		if (value != null) {
			// to check multi-checkbox all checked
			count = dup_params[key];
			if (count == null) count = 1;
			dup_params[key] = count+1;
		} else
			value = '';
		value += input.val();
		params[key] = value;
	});

	for(const key in dup_params) {
		tags = $('#chart_conditions #'+key);
		// if multi-checkbox all checked clear the condition
		if (dup_params[key] == tags.length)
			params[key] = '';
	}

	return params;

}
*/
function requestSaleStat() {

	var params = getChartConditions();
	//var params = getForm2Map();

	var title;
	if ($("select#dong")[0].selectedIndex <= 0) {
		title = $('select#region option:checked').text();
	} else {
		title = $('select#region option:checked').text() + " " + $('select#dong option:checked').text();
	}

	// delete unnecessary parameter 'apt' for region stat
	delete params['apt'];
	drawSaleStat(params, title);

}

function requestSaleLine() {

	var title = $('select#apt option:selected').text();
	var params = getChartConditions();

	drawSaleLineChart(params, title);

}

function requestRankChart(gubun) {

	var params = getChartConditions();

	drawRankChart(gubun, params);
}

function toggleTerms() {
	if($('#toggle_term').is(':visible')) {
		$('#toggle_term').hide();
		$('#toggle_btn').text('▼ 보이기');
	} else {
		$('#toggle_term').show();
		$('#toggle_btn').text('▲ 숨기기');
	}
}

function toggleYMTable(btn, target, desc) {
	var div;
	if (desc)
		div = $("#ym_table_desc_div");
	else
		div = $("#ym_table_asc_div");
	if (div.is(':visible')) {
		$('.pop').hide();
		$('#toggle_btn').text('▼ 보이기');
	} else {
		$('.pop').hide();
		var pos = btn.position();
		div.attr("target", target);
		div.css({top: (pos.top+btn.outerHeight())+'px', left: pos.left+'px', display: 'block'});
	}
}

function wrapWindowByMask() { 
	//화면의 높이와 너비를 구한다. 
	var maskHeight = $(document).height(); 
	var maskWidth = $(window).width(); 
	
	//마스크의 높이와 너비를 화면 것으로 만들어 전체 화면을 채운다. 
	$('#fade').css({ 'width': maskWidth, 'height': maskHeight }); 
} 
	
/// 화면의 중앙에 레이어띄움 
function showMessage() { 
	wrapWindowByMask(); 
	$("#light").css("position", "absolute"); 
	$("#light").css("top", Math.max(0, (($(window).height() - $("#light").outerHeight()) / 2) + $(window).scrollTop() - 100) + "px"); 
	$("#light").css("left", Math.max(0, (($(window).width() - $("#light").outerWidth()) / 2) + $(window).scrollLeft()) + "px"); 
	$('#fade').show(); 
	$('#light').show(); 
} 

function closeMessage() { 
	$('#fade').hide(); 
	$('#light').hide(); 
}

</script>
<div class="sidebar" style="width:200px; margin-left:5px;">
	<div class="my-box" id="chart_conditions">
	<label><strong>조회기간</strong></label><br>
		<input id=from_ym readOnly style="width:60px;"><a onclick="event.stopPropagation(); toggleYMTable($(this), 'from_ym', false);">▼</a> ~ 
		<input id=to_ym readOnly style="width:60px;"><a onclick="event.stopPropagation(); toggleYMTable($(this), 'to_ym', true); return false;">▼</a><br>
		<table>
			<tr>
				<td>구 선택</td><td>동 선택</td>
			</tr>	
			<tr>
				<td>
					<select onchange="refreshDong(this.value);" name="region" id="region" style="width:100%;">
						<option value="11000">서울 전체</option>
					</select>
				</td>
				<td>
					<select onchange="refreshApt();" name="dong" id="dong" style="width:100%;">
						<option value="00000">구 전체</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>아파트 선택</td>
				<td style="font-size: small; padding-left: 0px; padding-right: 0px;">
					<input type=checkbox id=danji value=Y onchange="refreshApt();" />단지만
				</td>
			</tr>
			<tr>
				<td colspan = 2>
					<select name="apt" id="apt" style="width:100%;" onchange="$('#apt_btn').attr('disabled', $('select#apt option:selected').val() == '');"></select>
				</td>
			</tr>
		</table>
		<span class="bar-item"><strong>추가 조건</strong></span>&nbsp;&nbsp;<a id=toggle_btn onclick="toggleTerms();" >▼ 보이기</a><br>
		<div id=toggle_term style="display:none;">
			<label>연식:</label>
				<select id=ages>
					<option value="">ALL</option>
					{%for i in range(1, 20)%} 
					<option value={{i}}>{{i}}</option>
					{%endfor%} 
				</select> 년
				<select id=age_sign>
					<option value="<">이내</option>
					<option value="=>">이상</option>
				</select><br>
			<label>전용면적</label><br>
				<input type=checkbox id=area_type value=01 checked>60m<sup>2</sup> 이하<br>
				<input type=checkbox id=area_type value=02 checked>60~85m<sup>2</sup> 이하<br>
				<input type=checkbox id=area_type value=03 checked>85~135m<sup>2</sup> 이하<br>
				<input type=checkbox id=area_type value=04 checked>135m<sup>2</sup> 초과
		</div>
	</div>
	<div class="my-box">
		<label><strong>평균평단가 추이</strong></label><br>
		<button id='region_btn' onclick="requestSaleStat();">구/동별 평균평단가 추이</button>
		<button id='apt_btn' onclick="requestSaleLine();" disabled>아파트별 평균평단가 추이</button>
		<div id="gDrawOptions">
			<label><strong>차트 옵션</strong></label><br>
			<input id=draw_overlap type=checkbox onchange="setDrawOption(this);">겹쳐 그리기</input><br>
			<input id=draw_relative type=checkbox onchange="setDrawOption(this); updateChart();">상대수치로 보기</input><br>
			<input id=draw_ma type=checkbox onchange="setDrawOption(this); updateChart();">연간 이동평균 같이 보기</input><br>
			<input id=draw_volume type=checkbox onchange="setDrawOption(this); updateChart();">거래량 같이 보기<br></input>
		</div>
	</div>
	<div class="my-box" id="chart_conditions">
		<label><strong>연간 평균평단가 비교</strong></label><br>
			<input id=base_ym readOnly style="width:60px;"><a onclick="event.stopPropagation(); toggleYMTable($(this), 'base_ym', true);">▼</a> VS 
				<select id=years>
					{%for i in range(1, 20)%} 
					<option value={{i}}>{{i}}</option>
					{%endfor%} 
				</select>년전<br>
			<button onclick="requestRankChart('Region');">구별 순위</button><br>
			<button onclick="requestRankChart('Dong');">동별(위에서 구 선택)</button><br>
			<button onclick="requestRankChart('Apt');">아파트별(구/동 선택가능)</button><br>
	</div>
</div>
<div id="ym_table_asc_div" class=popup style="display: none; position:absolute; z-index:999;">
<table id="ym_table_asc">
	<tbody>
	</tbody>
</table>
</div>
<div id="ym_table_desc_div" class=popup style="display: none; position:absolute; z-index:999;">
<table id="ym_table_desc">
	<tbody>
	</tbody>
</table>
</div>
<script>
const MIN_YY = 2006;
const DEFAULT_PERIOD = 3;
$(document).ready(function(){ 
	var today = new Date();
	var yy = today.getFullYear();
	var mm = today.getMonth()+1;
	var to_ym = yy * 100 + mm;
	// from_ym set to 3 years minus one month ago
	var from_ym = (mm == 12 ? (yy - (DEFAULT_PERIOD - 1)) * 100 + 1 : (yy - DEFAULT_PERIOD) * 100 + mm + 1);
	for(var y = MIN_YY; y < to_ym / 100; y++) {
		var html = "<tr>";
		for(var m = 1; m <= 12; m++) {
			html += "<td class=one_ym>" + (y*100 + m <= to_ym ? (y + "" + (m < 10 ? "0"+m : m)) : "") + "</td>";
		}
		html += "</tr>:"
		$('#ym_table_asc > tbody:last').append(html);
	};
	$('input#from_ym').val(from_ym);
	$('input#to_ym').val(to_ym);
	$('input#base_ym').val(to_ym);
	for(var y = Number.parseInt(to_ym / 100); y >= MIN_YY; y--) {
		var html = "<tr>";
		for(var m = 1; m <= 12; m++) {
			html += "<td class=one_ym>" + (y*100 + m <= to_ym ? (y + "" + (m < 10 ? "0"+m : m)) : "") + "</td>";
		}
		html += "</tr>:"
		$('#ym_table_desc > tbody:last').append(html);
	};

	$('.one_ym').click( function() {
		var div = $($(this).parents('div')[0]);
		var target = div.attr("target");
		$('#'+target).val($(this).text());
		div.hide();
	});

	$(".one_ym").hover(function(){
		$(this).css("background-color", "yellow");
    }, function(){
		$(this).css("background-color", $(this).parent().css("background-color"));
	});

	$(window).click(function(e) {
		$('.popup').hide();
	});

	$.ajaxSetup({
		"error":function() { 
			alert("서버에서 오류가 발생했습니다.");
			closeMessage();
		}
	});

	$.getJSON("{{ config['BASE_URL'] }}getDong", function(data){
		list = JSON.parse(data);
		gRegionsMap = list[0];
		gDongsMap = list[1];
		initRegions();
	});
});

</script>

